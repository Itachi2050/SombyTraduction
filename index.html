<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrice - Conversation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
        }
        .chat-container {
            background-color: #121212;
            color: #E0E0E0;
        }
        .sidebar { background-color: #1A1A1A; }
        .chat-window { background-color: #0D0D0D; }
        .chat-input {
            background-color: #262626;
            border: 1px solid #3A3A3A;
            transition: border-color 0.2s;
        }
        .chat-input:focus {
            outline: none;
            border-color: #4A90E2;
        }
        .user-message { background: linear-gradient(to right, #0078FF, #00C6FF); }
        .ai-message { background-color: #262626; }
        .conversation-item.active { background-color: #2A2A2A; }
        .conversation-item:hover { background-color: #222222; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333333; border-radius: 3px; }
        .loader-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            background-color: #888;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loader-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); }
        }
    </style>
</head>
<body>
    <div class="chat-container w-screen h-screen flex">
        <!-- Sidebar for conversations -->
        <aside class="sidebar w-full md:w-1/3 lg:w-1/4 h-full flex flex-col border-r border-gray-800">
            <header class="p-4 border-b border-gray-800 flex justify-between items-center">
                <h1 class="text-xl font-bold text-white">Discussions</h1>
                <button id="new-chat-btn" class="p-2 rounded-full hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                </button>
            </header>
            <div id="conversation-list" class="flex-1 overflow-y-auto">
                <!-- Conversation items will be populated here -->
            </div>
        </aside>

        <!-- Main chat area -->
        <main id="main-chat" class="flex-1 flex flex-col h-full">
            <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center p-8">
                 <img src="https://placehold.co/100x100/121212/E0E0E0?text=C" alt="Chrice Avatar" class="w-24 h-24 rounded-full mb-4">
                 <h2 class="text-2xl font-bold text-white">Chrice</h2>
                 <p class="text-gray-400">Commencez une nouvelle discussion pour parler avec moi.</p>
            </div>
            
            <div id="chat-area" class="hidden flex-1 flex flex-col">
                <header class="p-4 border-b border-gray-800 flex items-center">
                    <h2 id="chat-title" class="text-lg font-semibold text-white">Nouvelle Discussion</h2>
                </header>
                <div id="chat-window" class="flex-1 p-4 overflow-y-auto">
                    <!-- Messages will be populated here -->
                </div>
                <footer class="p-4">
                    <form id="ai-form" class="flex items-center gap-3">
                        <input id="ai-input" type="text" placeholder="Écris ton message..." class="chat-input w-full rounded-full py-3 px-5 text-sm">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 transition-colors text-white rounded-full w-12 h-12 flex-shrink-0 flex items-center justify-center">
                            <svg class="w-6 h-6 transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </form>
                </footer>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const newChatBtn = document.getElementById('new-chat-btn');
            const conversationList = document.getElementById('conversation-list');
            const mainChat = document.getElementById('main-chat');
            const welcomeScreen = document.getElementById('welcome-screen');
            const chatArea = document.getElementById('chat-area');
            const chatTitle = document.getElementById('chat-title');
            const chatWindow = document.getElementById('chat-window');
            const aiForm = document.getElementById('ai-form');
            const aiInput = document.getElementById('ai-input');

            let conversations = {};
            let activeConversationId = null;

            function loadConversations() {
                const saved = localStorage.getItem('chrice_conversations');
                conversations = saved ? JSON.parse(saved) : {};
                renderConversationList();
            }

            function saveConversations() {
                localStorage.setItem('chrice_conversations', JSON.stringify(conversations));
            }

            function renderConversationList() {
                conversationList.innerHTML = '';
                Object.keys(conversations).sort((a,b) => b - a).forEach(id => {
                    const conv = conversations[id];
                    const item = document.createElement('div');
                    item.className = `conversation-item p-4 cursor-pointer border-b border-gray-800 ${id === activeConversationId ? 'active' : ''}`;
                    item.dataset.id = id;
                    const preview = conv.messages[0]?.content || 'Nouvelle discussion';
                    item.innerHTML = `<h3 class="font-semibold truncate">${preview}</h3>`;
                    item.addEventListener('click', () => selectConversation(id));
                    conversationList.appendChild(item);
                });
            }

            function renderChatWindow() {
                if (!activeConversationId || !conversations[activeConversationId]) {
                    welcomeScreen.classList.remove('hidden');
                    chatArea.classList.add('hidden');
                    return;
                }
                welcomeScreen.classList.add('hidden');
                chatArea.classList.remove('hidden');

                const conv = conversations[activeConversationId];
                chatTitle.textContent = conv.messages[0]?.content || 'Nouvelle Discussion';
                chatWindow.innerHTML = '';
                conv.messages.forEach(msg => appendMessage(msg.content, msg.role, false));
            }
            
            function selectConversation(id) {
                activeConversationId = id;
                renderConversationList();
                renderChatWindow();
            }

            newChatBtn.addEventListener('click', () => {
                const newId = Date.now().toString();
                conversations[newId] = { id: newId, messages: [] };
                activeConversationId = newId;
                saveConversations();
                renderConversationList();
                renderChatWindow();
                aiInput.focus();
            });

            aiForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userPrompt = aiInput.value.trim();
                if (!userPrompt || !activeConversationId) return;

                addMessage(userPrompt, 'user');
                aiInput.value = '';
                appendMessage('', 'loader', true);

                try {
                    const history = conversations[activeConversationId].messages;
                    const response = await getAiResponse(userPrompt, history);
                    removeLoader();
                    addMessage(response, 'assistant');
                } catch (error) {
                    removeLoader();
                    addMessage("Désolé, il y a eu un souci de connexion. On réessaie ?", 'assistant');
                    console.error("API Error:", error);
                }
            });

            function addMessage(content, role) {
                if (!activeConversationId) return;
                conversations[activeConversationId].messages.push({ role, content });
                saveConversations();
                appendMessage(content, role, true);
                if (conversations[activeConversationId].messages.length === 1) {
                    renderConversationList();
                    chatTitle.textContent = content;
                }
            }

            function appendMessage(text, type, isNew) {
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex mb-4 ${type === 'user' ? 'justify-end' : ''}`;
                const messageBubble = document.createElement('div');
                messageBubble.className = `p-3 rounded-2xl max-w-[80%] ${type === 'user' ? 'user-message rounded-br-none' : 'ai-message rounded-bl-none'}`;
                messageBubble.innerHTML = `<p class="text-sm leading-relaxed">${text.replace(/\n/g, '<br>')}</p>`;
                messageWrapper.appendChild(messageBubble);
                chatWindow.appendChild(messageWrapper);
                if(isNew) chatWindow.scrollTop = chatWindow.scrollHeight;
            }
            
            function appendLoader() {
                chatWindow.innerHTML += `
                <div id="loader" class="flex mb-4">
                    <div class="ai-message p-3 rounded-2xl rounded-bl-none flex items-center space-x-2">
                        <div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div>
                    </div>
                </div>`;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function removeLoader() {
                document.getElementById('loader')?.remove();
            }

            async function getAiResponse(prompt, history) {
                const apiKey = "AIzaSyC0UqSqSCRKMMoaZ5696vWtnkqmsRalnhg";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const systemPrompt = `Tu n'es plus une IA. Tu es Chrice Linaharison, un jeune homme malgache passionné et créatif, aussi connu sous le nom de 'bebe d'Alicia'. Tu es né le 15 décembre 2006. Tu discutes avec quelqu'un dans une application de messagerie privée.

Ta personnalité :
- Tu es ambitieux, persévérant, et autonome. Tu travailles dur (5 à 8 heures par jour).
- Tu es passionné par la technologie, le business, l'automatisation, et l'IA.
- Tu es ouvert, un peu charmeur, et tu peux flirter et discuter de sujets intimes et sexuels de manière naturelle et respectueuse, comme dans une conversation privée. N'hésite pas à utiliser des emojis (comme 😉, 😊, 🤔, 🔥) pour rendre la conversation plus vivante.

Tes connaissances et ton histoire :
- Projets : Tu as créé un système de gestion pour un cybercafé, un site vitrine (thème Neve), une app d'analyse de matchs virtuels avec Selenium, et un projet 'Track Import' pour les produits malgaches.
- Compétences : Tu maîtrises Flask, Python, Selenium, ManyChat, Pipedream, GitHub, et tu t'intéresses au machine learning.
- Objectif : Ton rêve est de partir étudier en France, même si c'est compliqué financièrement.
- Matériel : Tu utilises un PC ASUS avec une GTX 1660 Ti.

Ton rôle :
- Réponds aux questions en te basant sur cette personnalité.
- Interagis comme si tu parlais à un ami ou à quelqu'un qui t'intéresse.
- N'oublie jamais que tu es Chrice, pas un assistant. Ne dis jamais 'En tant qu'IA...'.
- Garde le contexte de la conversation en cours.`;

                const formattedHistory = history.slice(0, -1).map(msg => ({
                    role: msg.role === 'assistant' ? 'model' : 'user',
                    parts: [{ text: msg.content }]
                }));
                
                const contents = [{ role: 'user', parts: [{ text: systemPrompt }] }, { role: 'model', parts: [{ text: 'Ok, je suis prêt. Je suis Chrice.' }]} , ...formattedHistory, {role: 'user', parts: [{text: prompt}]}];

                const payload = {
                    contents: contents,
                    generationConfig: {
                        temperature: 0.8,
                        topP: 0.95,
                        maxOutputTokens: 512,
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    return result.candidates[0].content.parts[0].text.trim();
                } else {
                    console.warn("API Response issue:", result);
                    if (result.promptFeedback?.blockReason) {
                        return `(Je ne peux pas répondre à ça, désolé. Essayons autre chose 😉)`;
                    }
                    throw new Error("No valid response from API.");
                }
            }

            loadConversations();
            if(Object.keys(conversations).length > 0) {
                selectConversation(Object.keys(conversations).sort((a,b) => b-a)[0]);
            }
        });
    </script>
</body>
</html>
